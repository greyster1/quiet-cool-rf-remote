#include "quietcool.h"
#include "esphome/core/log.h"
#include "ELECHOUSE_CC1101_SRC_DRV.h"

namespace esphome {
namespace quiet_cool {

static const char *TAG = "quietcool";

// Command lookup table
const char* QuietCool::speed_settings[] = {
    "00001010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000000101100110110100011001100110011000", // PRE
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101100011011000100", // H1
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101100101011001000", // H2
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101101001011010000", // H4
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101110001011100000", // H8
    "00001010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000000101100110110100011001100110011000", // H12 //used by HA
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101111111011111100", // HON
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101100001011000000", // HOFF
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101000011010000100", // M1
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101000101010001000", // M2
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101001001010010000", // M4
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101010001010100000", // M8
    "00001010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000000101100110110100001011110010111100", // M12  //used by HA
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101011111010111100", // MON
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010101000001010000000", // MOFF
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010100100011001000100", // L1
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010100100101001001000", // L2
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010100101001001010000", // L4
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010100110001001100000", // L8
    "00001010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000000101100110110100000111110001111100", // L12  //used by HA
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010100111111001111100", // LON
    "000010101101010101010101010101010101010101010101010101010101010101010101000101101110101000000011011001011000000001111011111110010100100001001000000", // LOFF
};

// Define the pre-signal
// const char* QuietCool::preamble = "000010101011010101010101010101010101010101010101010101010101010101010101010001011011101010000000110110010110000000001011001101101000110011001100110000";

QuietCool::QuietCool(uint8_t csn, uint8_t gdo0, uint8_t gdo2, uint8_t sck, uint8_t miso, uint8_t mosi)
    : csn_pin(csn), gdo0_pin(gdo0), gdo2_pin(gdo2), sck_pin(sck), miso_pin(miso), mosi_pin(mosi) {}

// --- Initialize CC1101 and verify communication ---
bool QuietCool::initCC1101() {
    ESP_LOGD(TAG, "sck:%d, miso:%d, mosi:%d, csn:%d\n", sck_pin, miso_pin, mosi_pin, csn_pin);
    ELECHOUSE_cc1101.setSpiPin(sck_pin, miso_pin, mosi_pin, csn_pin);
    int tries = 10;
    bool detected = false;
    while (tries--) {
	uint8_t version = readChipVersion();
	ESP_LOGI(TAG, "CC1101 VERSION READ: 0x%02X", version);
	if (version == 0x14 || version == 0x04) {
	    ESP_LOGI(TAG, "CC1101 detected!");
	    detected = true;
	    break;
	}
    }
    if (!detected) {
	ESP_LOGE(TAG, "CC1101 not detected!");
	return false;
    }
    if (!ELECHOUSE_cc1101.getCC1101()) {
        ESP_LOGE(TAG, "CC1101 connection error");
        return false;
    }
    ELECHOUSE_cc1101.Init();

    // Basic configuration
    ELECHOUSE_cc1101.setMHZ(FREQ_MHZ);
    ELECHOUSE_cc1101.setPA(20); //G: increased power

    // Configure for direct mode transmission
    ELECHOUSE_cc1101.setCCMode(1);
    ELECHOUSE_cc1101.setModulation(0); // G: Changed back to 0
    ELECHOUSE_cc1101.setDeviation(10);
    ELECHOUSE_cc1101.setDRate(2.398);

    // Disable all packet handling
    ELECHOUSE_cc1101.setSyncMode(0);
    ELECHOUSE_cc1101.setWhiteData(false);
    ELECHOUSE_cc1101.setManchester(false);
    ELECHOUSE_cc1101.setPktFormat(3);
    ELECHOUSE_cc1101.setCrc(0);
    ELECHOUSE_cc1101.setLengthConfig(0);
    ELECHOUSE_cc1101.setPacketLength(0);
    ELECHOUSE_cc1101.setPRE(0);

    // Configure GDO pins for direct mode
    ELECHOUSE_cc1101.setGDO(gdo0_pin, gdo2_pin);
    delay(500);

    return true;
}

void QuietCool::sendPacket(const char *data, uint8_t len) {
    for (int i = 0; i < 3; i++) {
        sendRawData(data, len);
        delay(18);
    }
}

void QuietCool::sendBits(const char *data, uint8_t len) {
    for (int bit = 0; bit < len; bit++) {
        digitalWrite(gdo0_pin, TO_BIT(data[bit]));
        delayMicroseconds(400); // Change from 415 to 400
    }
}

void QuietCool::sendRawData(const char* data, uint8_t len) {
    if (len == 0) {
        ESP_LOGE(TAG, "No data to send");
        return;
    }

    ESP_LOGD(TAG, "Sending %d bits", len);

   // const char *preamble = QuietCool::preamble; // Use the pre-signal as preamble
    digitalWrite(gdo0_pin, 0);
    noInterrupts();
    ELECHOUSE_cc1101.SetTx();
    delayMicroseconds(500); // Wait for TX mode stabilization
    //sendBits(preamble, strlen(preamble));
    sendBits(data, len);
    ELECHOUSE_cc1101.setSidle();
    interrupts();

    delay(10);
}

uint8_t QuietCool::readChipVersion() {
    return ELECHOUSE_cc1101.SpiReadReg(0xF1);
}

const char* QuietCool::getCommand(QuietCoolSpeed speed, QuietCoolDuration duration) {
    if (speed >= QUIETCOOL_SPEED_LAST || duration >= QUIETCOOL_DURATION_LAST) {
        ESP_LOGE(TAG, "Invalid speed or duration");
        return speed_settings[7];
    }

    const int BASE_HIGH = 1;
    const int BASE_MEDIUM = 8;
    const int BASE_LOW = 15;
    const int INDEX_OFF = 7;

    int index;
    switch (speed) {
        case QUIETCOOL_SPEED_HIGH:
            index = BASE_HIGH + duration;
            break;
        case QUIETCOOL_SPEED_MEDIUM:
            index = BASE_MEDIUM + duration;
            break;
        case QUIETCOOL_SPEED_LOW:
            index = BASE_LOW + duration;
            break;
        case QUIETCOOL_SPEED_OFF:
            index = INDEX_OFF;
            break;
        default:
            ESP_LOGE(TAG, "Unhandled speed");
            return speed_settings[INDEX_OFF];
    }

    const int total = sizeof(speed_settings) / sizeof(speed_settings[0]);
    if (index < 0 || index >= total) {
        ESP_LOGE(TAG, "Index out of bounds");
        return speed_settings[INDEX_OFF];
    }
    return speed_settings[index];
}

void QuietCool::begin() {
    ESP_LOGD(TAG, "gdo0_pin = %d, gdo2_pin = %d\n", gdo0_pin, gdo2_pin);
    pinMode(gdo0_pin, OUTPUT);
    pinMode(gdo2_pin, OUTPUT);
    digitalWrite(gdo0_pin, LOW);
    digitalWrite(gdo2_pin, LOW);

    ESP_LOGI(TAG, "Starting CC1101 setup");
    if (!initCC1101()) {
        ESP_LOGE(TAG, "CC1101 not detected");
        return;
    }
    ESP_LOGI(TAG, "CC1101 ready");
}

void QuietCool::send(QuietCoolSpeed speed, QuietCoolDuration duration) {
    ESP_LOGI(TAG, "send(%d, %d)", speed, duration);
    const char* cmd = getCommand(speed, duration);
    ESP_LOGI(TAG, "%s", cmd);
    if (cmd)
        sendPacket(cmd, strlen(cmd)); // Remove -1
}

}  // namespace quiet_cool
}  // namespace esphome 
